[TOC]

# Elasticsearch

# 1，简介

## 1.这是啥

先别管这是啥，就当个很快的检索器用着先。

操作基本就是通过url触发的样子。

## 2.三个玩意

- **Index（索引）**：相当于关系型数据库中的 **“数据库”**。
- **Mapping（映射）**：相当于关系型数据库中的 **“表结构”**。
- **Document（文档）**：相当于关系型数据库中的 **“一行数据”**。

# 2，URL操作

## 1.index

### 创建

```
PUT——http://127.0.0.1:9200/{index名}
```

创建一个索引对象。

### 查看

```
GET——http://127.0.0.1:9200/{index名}
```

查看指定索引对象。

### 删除

```
DELETE——http://127.0.0.1:9200/{index名}
```

删除指定索引对象。

### 关闭

```
POST——http://127.0.0.1:9200/{index名}/_close
```

关闭指定索引对象（类似标记为不可用）。

### 打开

```
POST——http://127.0.0.1:9200/{index名}/_open
```

打开指定索引对象（类似标记为可用）。

### 查看所有

```
GET——http://127.0.0.1:9200/_cat/indices
```

查看所有存在的索引对象。

## 2.mapping

### 创建

```
PUT——http://127.0.0.1:9200/{index名}/_mapping
```

```
Body参数（示例）：

{
  "properties":{
     "name": {
        "type": "keyword"
     },
     "age": {
        "type": "integer"
     },
     "birthplace": "text",
     "analyzer": "ik_max_word"
  }
}
```

创建一个映射对象，指向一个索引对象。

### 查看指定索引的

```
GET——http://127.0.0.1:9200/{index名}/_mapping
```

检查指定索引下的映射对象。

## 3.document

### 指定ID创建

```
PUT——http://127.0.0.1:9200/{index名}/_doc/1
```

```
Body参数（示例）：

{
   "name": "张三",
   "age": 21,
   "birthplace": "广东省广州市" 
}
```

定义ID创建文档对象，指向指定索引。

### 指定ID查询

```
GET——http://127.0.0.1:9200/{index名}/_doc/1
```

根据ID查询指定文档对象。

### 指定ID删除

```
DELETE——http://127.0.0.1:9200/{index名}/_doc/1
```

根据ID删除指定文档对象。

### 查看指定索引的

```
GET——http://127.0.0.1:9200/{index名}/_search
```

查看指定索引的所有文档对象。

## 4.文档检索

文档的检索全都使用相同的URL。

只有传递的参数不同。

```
GET——http://127.0.0.1:9200/{index名}/_search
```

### URL查询

```
Query参数（示例）：

参数名 name:值
```

查询匹配的文档，根据请求路径中指定的字段的值。

### term查询

```
Body参数（示例）：

{
    "query": {
        "term": {
            "birthplace" : "广州"
        }
    }
}
```

查询匹配的文档，根据指定的字段的值，做精确匹配，不分词。

### terms查询

```
Body参数（示例）：

{
    "query": {
        "terms": {
            "birthplace": ["珠海", "深圳"]
        }
    }
}
```

查询匹配的文档，根据指定的字段组的每个值（满足一个也可），做精确匹配，不分词。

### match查询

```
Body参数（示例）：

{
    "query": {
        "match": {
            "birthpalce": "广东广州"
        }
    }
}
```

查询匹配的文档，根据指定的字段的值，先分词再检索。

### multi_match查询

```
Body参数（示例）：

{
    "query": {
        "multi_match": {
            "query": "广州",
            "fields": ["name", "birthplace"]
        }
    }
}
```

查询匹配的文档，根据指定的字段的值，多个字段为参数的match。

### range查询

```
Body参数（示例）：

{
    "query": {
        "range": {
            "age": {
                "gte": 20,
                "lte": 24
            }
        }
    }
}
```

查询匹配的文档，根据指定的区间过滤。

### 通配符检索

```
Body参数（示例）：

{
    "query": {
        "wildcard": {
            "birthplace": "广东省*"
        }
    }
}
```

查询匹配的文档，根据通配符规则做模糊查。

### boolean查询

```
Body参数（示例）：

{
    "query": {
        "bool": {
            "must":{
                "match": {
                    "birthplace": "广东广州"
                }
            },
            "must": {
                "term": {
                    "name": "张三"
                }
            }
        }
    }
}
```

查询匹配的文档，使用不同查询方式做组合条件。

### 分组查询

```
Body参数（示例）：

{
    "aggs": {
        "birthplace_group": {
            "terms": {
                "field": "birthplace"
            }
        }
    }
}
```

查询匹配的文档，根据指定字段对其进行分组查。

### 统计

```
Body参数（示例）：

{
    "aggs": {
        "count_age": {
            "stats": {
                "field": "age"
            }
        }
    }
}
```

查询匹配的文档，根据聚合函数做指定字段的值的运算。

### 排序

```
Body参数（示例）：

{
    "query": {
        "match": {
            "birthplace": "广州"
        }
    },
    "sort": {
        "age": {
            "order": "desc"
        }
    }
}
```

查询匹配的文档，根据定义的排序规则操作结果。

### 分页查询

```
Body参数（示例）：

{
    "query": {
        "match": {
            "birthplace": "广东"
        }
    },
    "form": 0,
    "size": 2
}
```

查询匹配的文档，根据指定字段对其进行分组查，给定页码与页内容数。

### 高亮显示

```
Body参数（示例）：

{
    "query": {
        "match": {
            "birthplace": "广州"
        }
    },
    "hightlight": {
        "fields": {
            "birthplace": {}
        }
    }
}
```

查询匹配的文档，根据指定字段对其结果中匹配的关键字做高亮标记。

# 3，Java操作

就是在代码里操作ES。

这里仅列一些基本简单的操作（课上只敲了这些）。

其它的自己去网上找。

## 1.准备

首先加依赖。

ES在SB中也是有封好的启动包的。

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
</dependency>
```

然后加配置。

非常短。

```yaml
spring:
    application:
        name: ch13
    elasticsearch:
        # 连接es的服务器地址，要连接多个使用逗号隔开
        uris: http://localhost:9200
        # 连接超时时间
        connection-timeout: 2s
        # 认证的账号和密码（若有）
        # username: xxx
        # password: xxx
```

然后是做一个映射对象。

指向Index，就是索引（对应数据库的表）。

```java
package com.example.ch13.document;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.elasticsearch.annotations.Document;
import org.springframework.data.elasticsearch.annotations.Field;
import org.springframework.data.elasticsearch.annotations.FieldType;

/**
 * 文档映射，映射Users索引中的属性
 */
@Document(indexName = "users", createIndex = false)
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Users {
    @Id
    private String id;

    @Field(type = FieldType.Keyword, index = false)
    private String name;

    @Field(type = FieldType.Integer, index = false)
    private Integer age;

    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String birthplace;
}
```

## 2.使用

在测试类里加个ES的操作对象先。

```java
@Autowired
private ElasticsearchOperations elasticsearchOperations;
```

### 创建索引

```java
@Test
void createIndex() {
    if(!elasticsearchOperations.indexOps(Users.class).exists()) {
        elasticsearchOperations.indexOps(Users.class).create();
        log.info("已创建");
    } else {
        log.info("已存在");
    }
}
```

### 删除索引

```java
@Test
void deleteIndex() {
    if(elasticsearchOperations.indexOps(Users.class).exists()) {
        elasticsearchOperations.indexOps(Users.class).delete();
        log.info("已删除");
    } else {
        log.info("不存在");
    }
}
```

### 创建映射

```java
@Test
void createMapping() {
    Document document = elasticsearchOperations.indexOps(Users.class).createMapping(Users.class);
    elasticsearchOperations.indexOps(Users.class).putMapping(document);
}
```

### 创建文档

```java
@Test
void createDocument() {
    Users u1 = new Users("1", "张三", 20, "广东省珠海市香洲区");
    Users u2 = new Users("2", "李四", 21, "广东省珠海市唐家区");
    Users u3 = new Users("3", "王五", 22, "广东省广州市越秀区");
    Users u4 = new Users("4", "赵六", 23, "广东省珠海市香洲区");
    Users u5 = new Users("5", "珠海", 21, "广东省珠海市香洲区");
    elasticsearchOperations.save(u1, u2, u3, u4, u5);
}
```

### 删除文档

```java
@Test
void deleteDocument() {
    elasticsearchOperations.delete("1", Users.class);
}
```

### 修改文档

```java
@Test
void updateDocument() {
    elasticsearchOperations.update(new Users("1", "张三芜", 20, "广东省珠海市香洲区"));
}
```

### 根据ID查文档

```java
@Test
void selectDocumentById() {
    Users users = elasticsearchOperations.get("1", Users.class);
    log.info(users.toString());
}
```

### 查所有文档

```java
@Test
void selectDocument() {
    NativeQuery nativeQuery = NativeQuery.builder().build();
    SearchHits<Users> hits = elasticsearchOperations.search(nativeQuery, Users.class);
    hits.getSearchHits().forEach(hit -> {
        Users user = hit.getContent();
        log.info(user.toString());
    });
}
```